@model VideoLibrary.Models.Video

@{
    ViewData["Title"] = Model.Title;
    var loop = (Model.FilePath.Contains("clip"));


}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Tags</a></li>
        <li class="breadcrumb-item active" aria-current="page">@Model.Title</li>
    </ol>
</nav>

<h1>@Model.Title</h1>

<div class="row">
    <div class="col-md-8">
        <div class="ratio ratio-16x9">
            <video controls class="rounded" loop="true" id="mainVideo">
                <source src="@Url.Action("Stream", "Video", new { id = Model.Id })" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        </div>

        <div class="mt-3">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Added:</strong> @Model.DateAdded.ToString("MMM dd, yyyy HH:mm")</p>
                    <p><strong>Duration:</strong> @Model.DurationFormatted</p>
                    <p><strong>Resolution:</strong> @Model.ResolutionFormatted</p>
                </div>
                <div class="col-md-6">
                    <p><strong>File:</strong> @System.IO.Path.GetFileName(Model.FilePath)</p>
                    <p><strong>File Size:</strong> @Model.FileSizeFormatted</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Tags</h5>
                <a href="@Url.Action("Edit", "Video", new { id = Model.Id })" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-pencil"></i> Edit
                </a>
            </div>
            <div class="card-body">
                @if (Model.VideoTags.Any())
                {
                    <div class="d-flex flex-wrap gap-1">
                        @foreach (var videoTag in Model.VideoTags)
                        {
                            <a href="@Url.Action("ByTag", "Video", new { tagId = videoTag.Tag.Id })"
                            class="badge bg-primary tag-badge">@videoTag.Tag.Name</a>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">No tags assigned</p>
                    <a href="@Url.Action("Edit", "Video", new { id = Model.Id })" class="btn btn-sm btn-primary">Add Tags</a>
                }
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Notes</h5>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleNotesEdit()">
                    <i class="bi bi-pencil" id="editIcon"></i> <span id="editText">Edit</span>
                </button>
            </div>
            <div class="card-body">
                <div id="notesDisplay" style="@(string.IsNullOrEmpty(Model.Notes) ? "display: none;" : "")">
                    <div class="notes-content">
                             @{
    var formattedNotes = Model.Notes != null 
        ? Html.Encode(Model.Notes).Replace("&#xD;&#xA;", "<br>")  // Windows
         : "";
}
@Html.Raw(formattedNotes)

                    </div>
                </div>

                <div id="notesEdit" style="display: none;">
                    <form asp-action="SaveNotes" method="post">
                        <input type="hidden" name="videoId" value="@Model.Id">
                        <div class="mb-3">
                            <textarea name="notes" class="form-control" rows="8" 
                                      placeholder="Add your notes about this video...">@Model.Notes</textarea>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="bi bi-check"></i> Save Notes
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="cancelNotesEdit()">
                                <i class="bi bi-x"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>

            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">Thumbnail</h5>
            </div>
            <div class="card-body">
                <form asp-action="RefreshThumbnail" method="post">
                    <input type="hidden" name="videoId" value="@Model.Id">
                    <div class="input-group">
                        <input type="number" name="seconds" value="30" min="0" class="form-control form-control-sm"
                               placeholder="Seconds" title="Time in seconds to capture thumbnail">
                        <button type="submit" class="btn btn-sm btn-outline-secondary">Refresh</button>
                    </div>
                    <small class="form-text text-muted">Generate thumbnail from specific time (seconds)</small>
                </form>
            </div>
        </div>

        <div class="card mt-3">
    <div class="card-header">
        <button class="btn btn-link p-0 text-decoration-none w-100 text-start" 
                type="button" data-bs-toggle="collapse" data-bs-target="#clippingPanel">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-scissors"></i> Create Video Clip
                </h5>
                <i class="bi bi-chevron-down"></i>
            </div>
        </button>
    </div>
    <div class="collapse" id="clippingPanel">
        <div class="card-body">
            <form asp-action="CreateClip" method="post" id="clippingForm">
                <input type="hidden" name="videoId" value="@Model.Id">

                <div class="mb-3">
                    <label class="form-label">Start Time (seconds)</label>
                    <div class="input-group input-group-sm">
                        <input type="number" name="startSeconds" id="startSeconds" 
                               class="form-control" step="0.1" min="0" 
                               placeholder="0.0" required>
                        <button type="button" class="btn btn-outline-secondary" 
                                onclick="setCurrentTime('start')" title="Use current video time">
                            <i class="bi bi-cursor"></i>
                        </button>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">End Time (seconds)</label>
                    <div class="input-group input-group-sm">
                        <input type="number" name="endSeconds" id="endSeconds" 
                               class="form-control" step="0.1" min="0" 
                               placeholder="10.0" required>
                        <button type="button" class="btn btn-outline-secondary" 
                                onclick="setCurrentTime('end')" title="Use current video time">
                            <i class="bi bi-cursor"></i>
                        </button>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between text-muted small">
                        <span>Duration: <span id="clipDuration">0.0s</span></span>
                        <span>Video Length: @Model.DurationFormatted</span>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-sm w-100" id="createClipBtn">
                    <i class="bi bi-scissors"></i> Create Clip
                </button>
            </form>
        </div>
    </div>
</div>

        <div class="mt-3">


            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show">
                    @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show">
                    @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <form asp-action="ReAnalyzeVideo" method="post" class="d-inline">
                <input type="hidden" name="videoId" value="@Model.Id">
                <button type="submit" class="btn btn-sm btn-outline-info">Re-analyze Video</button>
            </form>
        </div>
    </div>
</div>

<div class="mt-4">
    <a href="javascript:history.back()" class="btn btn-secondary">Back</a>
</div>

                    <script>
function toggleNotesEdit() {
    const display = document.getElementById('notesDisplay');
    const edit = document.getElementById('notesEdit');
    const empty = document.getElementById('notesEmpty');
    const editIcon = document.getElementById('editIcon');
    const editText = document.getElementById('editText');

    if (edit.style.display === 'none') {
        // Switch to edit mode
        display.style.display = 'none';
        if (empty) empty.style.display = 'none';
        edit.style.display = 'block';
        editIcon.className = 'bi bi-x';
        editText.textContent = 'Cancel';

        // Focus on textarea
        const textarea = edit.querySelector('textarea');
        textarea.focus();
    } else {
        // Switch to display mode
        cancelNotesEdit();
    }
}

function cancelNotesEdit() {
    const display = document.getElementById('notesDisplay');
    const edit = document.getElementById('notesEdit');
    const empty = document.getElementById('notesEmpty');
    const editIcon = document.getElementById('editIcon');
    const editText = document.getElementById('editText');
    const hasNotes = display.querySelector('.notes-content').textContent.trim() !== '';

    edit.style.display = 'none';
    editIcon.className = 'bi bi-pencil';
    editText.textContent = 'Edit';

    if (hasNotes) {
        display.style.display = 'block';
    } else if (empty) {
        empty.style.display = 'block';
    }
}

// Auto-save functionality (optional)
let saveTimeout;
function autoSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        const form = document.querySelector('#notesEdit form');
        if (form && document.getElementById('notesEdit').style.display !== 'none') {
            // Could implement auto-save via AJAX here
        }
    }, 2000);
}

// Add auto-save listener
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.querySelector('#notesEdit textarea');
    if (textarea) {
        textarea.addEventListener('input', autoSave);
    }
});

function setCurrentTime(type) {
    const video = document.getElementById('mainVideo');
    const currentTime = video.currentTime;

    if (type === 'start') {
        document.getElementById('startSeconds').value = currentTime.toFixed(1);
    } else if (type === 'end') {
        document.getElementById('endSeconds').value = currentTime.toFixed(1);
    }

    updateClipDuration();
}

function updateClipDuration() {
    const startInput = document.getElementById('startSeconds');
    const endInput = document.getElementById('endSeconds');
    const durationSpan = document.getElementById('clipDuration');

    const start = parseFloat(startInput.value) || 0;
    const end = parseFloat(endInput.value) || 0;
    const duration = Math.max(0, end - start);

    durationSpan.textContent = duration.toFixed(1) + 's';

    // Update button state
    const createBtn = document.getElementById('createClipBtn');
    if (duration > 0 && start >= 0) {
        createBtn.disabled = false;
        createBtn.classList.remove('btn-secondary');
        createBtn.classList.add('btn-primary');
    } else {
        createBtn.disabled = true;
        createBtn.classList.remove('btn-primary');
        createBtn.classList.add('btn-secondary');
    }
}

// Add event listeners for duration calculation
document.addEventListener('DOMContentLoaded', function() {
    const startInput = document.getElementById('startSeconds');
    const endInput = document.getElementById('endSeconds');

    if (startInput && endInput) {
        startInput.addEventListener('input', updateClipDuration);
        endInput.addEventListener('input', updateClipDuration);

        // Initial calculation
        updateClipDuration();
    }

    // Add form validation
    const clippingForm = document.getElementById('clippingForm');
    if (clippingForm) {
        clippingForm.addEventListener('submit', function(e) {
            const start = parseFloat(document.getElementById('startSeconds').value) || 0;
            const end = parseFloat(document.getElementById('endSeconds').value) || 0;

            if (start >= end) {
                e.preventDefault();
                alert('End time must be after start time');
                return false;
            }

            if (start < 0) {
                e.preventDefault();
                alert('Start time cannot be negative');
                return false;
            }

            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating Clip...';
            submitBtn.disabled = true;
        });
    }
});

// Keyboard shortcuts for clipping
document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT') return;

    if (e.key === '[') {
        e.preventDefault();
        setCurrentTime('start');
    } else if (e.key === ']') {
        e.preventDefault();
        setCurrentTime('end');
    }
});
</script>

<style>
.notes-content {
    word-wrap: break-word;
}

.card .btn-sm {
    font-size: 0.8rem;
}

#notesEdit textarea {
    resize: vertical;
    min-height: 100px;
}

.tag-badge {
    font-size: 0.9em;
    padding: 0.4em 0.8em;
    margin: 0.2em;
    text-decoration: none;
}

.tag-badge:hover {
    transform: scale(1.05);
    transition: transform 0.2s;
}

    .collapse .card-body {
        background-color: #f8f9fa;
    }

    .alert-sm {
        padding: 0.5rem;
        margin-bottom: 0.75rem;
        font-size: 0.875rem;
    }

    #clippingPanel .btn-link {
        color: inherit;
        border: none;
        background: none;
    }

        #clippingPanel .btn-link:hover {
            color: #0d6efd;
        }

    #clippingPanel .bi-chevron-down {
        transition: transform 0.2s;
    }

    #clippingPanel.show .bi-chevron-down {
        transform: rotate(180deg);
    }

    .input-group-sm .btn {
        padding: 0.25rem 0.5rem;
    }
</style>