@model VideoLibrary.Models.VideoViewModel

@{
    ViewData["Title"] = Model.Video.Title;
    var loop = (Model.Video.FilePath.Contains("clip"));

    int tagId = Model.Video.VideoTags.First().TagId;
    string tagName = Model.Video.Title;

    if (Model.Tag is not null)
    {
        tagId = Model.Tag.Id;
        tagName = Model.Tag.Name;
    }
}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Tags</a></li>
        <li class="breadcrumb-item active" aria-current="page"><a href="@Url.Action("ByTag", "Video", new { tagId = tagId })">@tagName</a></li>
    </ol>
</nav>

<h2>@Model.Video.Title</h2>

<div class="row">
    <div class="col-md-8">
        <div class="ratio ratio-16x9">
            <video controls class="rounded" loop="true" id="mainVideo" poster="@Url.Action("Thumbnail", "Video", new { id = Model.Video.Id })">
                <source src="@Url.Action("Stream", "Video", new { id = Model.Video.Id })" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        </div>

        <div class="mt-3">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Added:</strong> @Model.Video.DateAdded.ToString("MMM dd, yyyy HH:mm")</p>
                    <p><strong>Duration:</strong> @Model.Video.DurationFormatted</p>
                    <p><strong>Resolution:</strong> @Model.Video.ResolutionFormatted</p>
                </div>
                <div class="col-md-6">
                    <p><strong>File:</strong> @System.IO.Path.GetFileName(Model.Video.FilePath)</p>
                    <p><strong>File Size:</strong> @Model.Video.FileSizeFormatted</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Tags</h5>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="editTags()">
                    <i class="bi bi-pencil"></i> Edit
                </button>
            </div>
            <div class="card-body">
                <div id="tagsView">
                @if (Model.Video.VideoTags.Any())
                {
                    <div class="d-flex flex-wrap gap-1">
                        @foreach (var videoTag in Model.Video.VideoTags)
                        {
                            <a href="@Url.Action("ByTag", "Video", new { tagId = videoTag.Tag.Id })"
                            class="badge bg-primary tag-badge">@videoTag.Tag.Name</a>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">No tags assigned</p>
                }
                </div>
                <div id="tagsEdit" style="display: none">
                    <form asp-action="UpdateTags" method="post">
                        <input type="hidden" name="videoId" value="@Model.Video.Id">
                        <input type="hidden" name="selectedTags" id="existingTagIds" value="">
                        <input type="hidden" name="newTags" id="newTagValues" value="">
                        <div class="mb-3">
                            <div class="tag-input-container">
                                <div class="selected-tags" id="selectedTags"></div>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="tagSearch"
                                           placeholder="Start typing to search tags..." autocomplete="off">
                                </div>
                                <div class="dropdown-menu" id="tagDropdown" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="bi bi-check"></i> Save Tags
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="cancelTagsEdit()">
                                <i class="bi bi-x"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Notes</h5>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleNotesEdit()">
                    <i class="bi bi-pencil" id="editIcon"></i> <span id="editText">Edit</span>
                </button>
            </div>
            <div class="card-body">
                <div id="notesDisplay" style="@(string.IsNullOrEmpty(Model.Video.Notes) ? "display: none;" : "")">
                    <div class="notes-content">
                             @{
    var formattedNotes = Model.Video.Notes != null
                            ? Html.Encode(Model.Video.Notes).Replace("&#xD;&#xA;", "<br>")  // Windows
         : "";
}
@Html.Raw(formattedNotes)

                    </div>
                </div>

                <div id="notesEdit" style="display: none;">
                    <form asp-action="SaveNotes" method="post">
                        <input type="hidden" name="videoId" value="@Model.Video.Id">
                        <div class="mb-3">
                            <textarea name="notes" class="form-control" rows="8" 
                                      placeholder="Add your notes about this video...">@Model.Video.Notes</textarea>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="bi bi-check"></i> Save Notes
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="cancelNotesEdit()">
                                <i class="bi bi-x"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>

            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <button class="btn btn-link p-0 text-decoration-none w-100 text-start"
                        type="button" data-bs-toggle="collapse" data-bs-target="#playlistPanel">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            Add to Playlist
                        </h5>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                </button>
            </div>
            <div class="collapse" id="playlistPanel">
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <!-- Existing thumbnail and re-analyze buttons can go here -->
                        <form asp-action="AddVideo" asp-controller="Playlist" method="post">
                            <input type="hidden" name="videoId" value="@Model.Video.Id">
                            <div class="input-group">
                                <select name="playlistId" asp-items="@(new SelectList(Model.Playlists, "Id", "Name"))" class="form-control">
                                    <option value="">-- Select an playlist --</option>
                                </select>
                                <button type="submit" class="btn btn-sm btn-outline-secondary">Add</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <button class="btn btn-link p-0 text-decoration-none w-100 text-start"
                        type="button" data-bs-toggle="collapse" data-bs-target="#clippingPanel">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            Create Video Clip
                        </h5>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                </button>
            </div>
            <div class="collapse" id="clippingPanel">
                <div class="card-body">
                    <form asp-action="CreateClip" method="post" id="clippingForm">
                        <input type="hidden" name="videoId" value="@Model.Video.Id">

                        <div class="mb-3">
                            <label class="form-label">Start Time (seconds)</label>
                            <div class="input-group input-group-sm">
                                <input type="number" name="startSeconds" id="startSeconds"
                                       class="form-control" step="0.1" min="0"
                                       placeholder="0.0" required>
                                <button type="button" class="btn btn-outline-secondary"
                                        onclick="setCurrentTime('start')" title="Use current video time">
                                    <i class="bi bi-cursor"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">End Time (seconds)</label>
                            <div class="input-group input-group-sm">
                                <input type="number" name="endSeconds" id="endSeconds"
                                       class="form-control" step="0.1" min="0"
                                       placeholder="10.0" required>
                                <button type="button" class="btn btn-outline-secondary"
                                        onclick="setCurrentTime('end')" title="Use current video time">
                                    <i class="bi bi-cursor"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between text-muted small">
                                <span>Duration: <span id="clipDuration">0.0s</span></span>
                                <span>Video Length: @Model.Video.DurationFormatted</span>
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary btn-sm" id="previewClipBtn">
                            Preview Clip
                        </button>

                        <button type="submit" class="btn btn-primary btn-sm" id="createClipBtn">
                            <i class="bi bi-scissors"></i> Create Clip
                        </button>
                    </form>
                    
                </div>
                <div class="card-body">
                    <a href="@Url.Action("Index", "VideoEditing", new { videoId = Model.Video.Id })"
                       class="btn btn-outline-primary">
                        <i class="bi bi-scissors"></i> Edit complete video
                    </a>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <button class="btn btn-link p-0 text-decoration-none w-100 text-start"
                        type="button" data-bs-toggle="collapse" data-bs-target="#thumbPanel">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            Thumbnail
                        </h5>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                </button>
            </div>
            <div class="collapse" id="thumbPanel">
                <div class="card-body">
                <div class="d-grid gap-2">
                    <!-- Existing thumbnail and re-analyze buttons can go here -->
                    <form asp-action="RefreshThumbnail" method="post">
                        <input type="hidden" name="videoId" value="@Model.Video.Id">
                        <div class="input-group">
                            <input type="number" name="seconds" value="30" min="0" class="form-control form-control-sm"
                                   placeholder="Seconds" title="Time in seconds to capture thumbnail">
                            <button type="submit" class="btn btn-sm btn-outline-secondary">Generate Thumbnail</button>
                        </div>
                        <small class="form-text text-muted">Generate thumbnail from specific time (seconds)</small>
                    </form>
                </div>
            </div>
            </div>
        </div>


        <div class="mt-3">


            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show">
                    @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show">
                    @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <form asp-action="ReAnalyzeVideo" method="post" class="d-inline">
                <input type="hidden" name="videoId" value="@Model.Video.Id">
                <button type="submit" class="btn btn-sm btn-outline-info">Re-analyze Video</button>
            </form>
        </div>
    </div>
</div>

<div class="mt-4">
    <a href="javascript:history.back()" class="btn btn-secondary">Back</a>
</div>

<script>

const previewBtn = document.getElementById('previewClipBtn');
const video = document.getElementById('mainVideo');
let previewActive = false;
let clipStart = 0;
let clipEnd = 0;

function toggleNotesEdit() {
    const display = document.getElementById('notesDisplay');
    const edit = document.getElementById('notesEdit');
    const empty = document.getElementById('notesEmpty');
    const editIcon = document.getElementById('editIcon');
    const editText = document.getElementById('editText');

    if (edit.style.display === 'none') {
        // Switch to edit mode
        display.style.display = 'none';
        if (empty) empty.style.display = 'none';
        edit.style.display = 'block';
        editIcon.className = 'bi bi-x';
        editText.textContent = 'Cancel';

        // Focus on textarea
        const textarea = edit.querySelector('textarea');
        textarea.focus();
    } else {
        // Switch to display mode
        cancelNotesEdit();
    }
}

function cancelNotesEdit() {
    const display = document.getElementById('notesDisplay');
    const edit = document.getElementById('notesEdit');
    const empty = document.getElementById('notesEmpty');
    const editIcon = document.getElementById('editIcon');
    const editText = document.getElementById('editText');
    const hasNotes = display.querySelector('.notes-content').textContent.trim() !== '';

    edit.style.display = 'none';
    editIcon.className = 'bi bi-pencil';
    editText.textContent = 'Edit';

    if (hasNotes) {
        display.style.display = 'block';
    } else if (empty) {
        empty.style.display = 'block';
    }
}

// Auto-save functionality (optional)
let saveTimeout;
function autoSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        const form = document.querySelector('#notesEdit form');
        if (form && document.getElementById('notesEdit').style.display !== 'none') {
            // Could implement auto-save via AJAX here
        }
    }, 2000);
}

// Add auto-save listener
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.querySelector('#notesEdit textarea');
    if (textarea) {
        textarea.addEventListener('input', autoSave);
    }
});

function setCurrentTime(type) {
    const currentTime = video.currentTime;

    if (type === 'start') {
        document.getElementById('startSeconds').value = currentTime.toFixed(1);
    } else if (type === 'end') {
        document.getElementById('endSeconds').value = currentTime.toFixed(1);
    }

    updateClipDuration();
}

function updateClipDuration() {
    const startInput = document.getElementById('startSeconds');
    const endInput = document.getElementById('endSeconds');
    const durationSpan = document.getElementById('clipDuration');

    clipStart = parseFloat(startInput.value) || 0;
    clipEnd = parseFloat(endInput.value) || 0;
    const duration = Math.max(0, clipEnd - clipStart);

    durationSpan.textContent = duration.toFixed(1) + 's';

    // Update button state
    const createBtn = document.getElementById('createClipBtn');

    if (duration > 0 && clipStart >= 0) {
        createBtn.disabled = false;
        createBtn.classList.remove('btn-secondary');
        createBtn.classList.add('btn-primary');

        previewBtn.disabled = false;
        previewBtn.classList.remove('btn-secondary');
        previewBtn.classList.add('btn-primary');
    } else {
        createBtn.disabled = true;
        createBtn.classList.remove('btn-primary');
        createBtn.classList.add('btn-secondary');

        previewBtn.disabled = true;
        previewBtn.classList.remove('btn-primary');
        previewBtn.classList.add('btn-secondary');
    }
}

video.addEventListener('timeupdate', function() {
    if (previewActive)
    {
        if (video.currentTime > clipEnd)
        {
            video.pause();
            previewActive = false;
        }
    }
});

previewBtn.addEventListener('click', function() {
    video.currentTime = clipStart;

    if (video.paused)
    {
        video.play();
    }

    previewActive = true;
});

// Add event listeners for duration calculation
document.addEventListener('DOMContentLoaded', function() {
    const startInput = document.getElementById('startSeconds');
    const endInput = document.getElementById('endSeconds');

    if (startInput && endInput) {
        startInput.addEventListener('input', updateClipDuration);
        endInput.addEventListener('input', updateClipDuration);

        // Initial calculation
        updateClipDuration();
    }

    // Add form validation
    const clippingForm = document.getElementById('clippingForm');
    if (clippingForm) {
        clippingForm.addEventListener('submit', function(e) {
            const start = parseFloat(document.getElementById('startSeconds').value) || 0;
            const end = parseFloat(document.getElementById('endSeconds').value) || 0;

            if (start >= end) {
                e.preventDefault();
                alert('End time must be after start time');
                return false;
            }

            if (start < 0) {
                e.preventDefault();
                alert('Start time cannot be negative');
                return false;
            }

            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating Clip...';
            submitBtn.disabled = true;
        });
    }
});

// Keyboard shortcuts for clipping
document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT') return;

    if (e.key === '[') {
        e.preventDefault();
        setCurrentTime('start');
    } else if (e.key === ']') {
        e.preventDefault();
        setCurrentTime('end');
    }
});
</script>

<script>

    class MultiTagSelector {
        constructor() {
            let tagData = @Html.Raw(Json.Serialize(Model.Video.VideoTags.Select(vt => new { id = vt.Tag.Id, name = vt.Tag.Name })));
            this.selectedTags = new Map(tagData.map(tag => [tag.id, tag.name]));
            this.allTags = [];
            this.initializeEventListeners();

            this.newTagId = -1;
        }

        initializeEventListeners() {
            const tagSearch = document.getElementById('tagSearch');
            const tagDropdown = document.getElementById('tagDropdown');

            // Input event for autocomplete
            tagSearch.addEventListener('input', (e) => {
                this.handleSearchInput(e.target.value);
            });

            // Handle Enter key
            tagSearch.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const dropdown = document.getElementById('tagDropdown');
                    const firstItem = dropdown.querySelector('.dropdown-item');
                    if (firstItem && dropdown.style.display != 'none') {
                        firstItem.click();
                    }
                    else {
                        // treat it as a new tag
                        this.selectTag(this.newTagId, e.target.value);
                    }
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.tag-input-container')) {
                    tagDropdown.style.display = 'none';
                }
            });
        }

        handleSearchInput(searchTerm) {
            const dropdown = document.getElementById('tagDropdown');

            if (searchTerm.trim() === '') {
                dropdown.style.display = 'none';
                return;
            }

            const filteredTags = this.allTags.filter(tag =>
                tag.name.toLowerCase().includes(searchTerm.toLowerCase()) &&
                !this.selectedTags.has(tag.id)
            );

            this.renderDropdown(filteredTags, searchTerm);
        }

        renderDropdown(tags, searchTerm) {
            const dropdown = document.getElementById('tagDropdown');

            if (tags.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            const html = tags.slice(0, 10).map(tag => `
                <button type="button" class="dropdown-item" onclick="multiTagSelector.selectTag(${tag.id}, '${tag.name}')">
                    <i class="bi bi-tag"></i> ${this.highlightMatch(tag.name, searchTerm)}
                </button>
            `).join('');

            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
            dropdown.style.position = 'absolute';
            dropdown.style.top = '100%';
            dropdown.style.left = '0';
            dropdown.style.right = '0';
            dropdown.style.zIndex = '1000';
        }

        highlightMatch(text, searchTerm) {
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<strong>$1</strong>');
        }

        selectTag(tagId, tagName) {
            this.selectedTags.set(tagId, tagName);
            this.renderSelectedTags();
            //this.updateUI();

            if (tagId < 0) {
                this.newTagId--;
            }

            // Clear search input
            document.getElementById('tagSearch').value = '';
            document.getElementById('tagDropdown').style.display = 'none';
        }

        removeTag(tagId) {
            this.selectedTags.delete(tagId);
            this.renderSelectedTags();
            //this.updateUI();
        }

        renderSelectedTags() {
            const container = document.getElementById('selectedTags');

            if (this.selectedTags.size === 0) {
                container.innerHTML = '';
                return;
            }

            const html = Array.from(this.selectedTags.entries()).map(([tagId, tagName]) => `
                <span class="badge bg-primary me-1 mb-1 selected-tag">
                    ${tagName}
                    <button type="button" class="btn-close btn-close-white ms-1"
                            onclick="multiTagSelector.removeTag(${tagId})" style="font-size: 0.7em;"></button>
                </span>
            `).join('');

            container.innerHTML = html;

            const existingTagIds = [];
            const newTagValues = [];

            // Iterate through the map
            this.selectedTags.forEach((value, id) => {
                if (id > 0) {
                    existingTagIds.push(id);
                } else if (id < 0) {
                    newTagValues.push(value);
                }
            });

            document.getElementById('existingTagIds').value = existingTagIds.join(',');
            document.getElementById('newTagValues').value = newTagValues.join(',');
        }

        updateUI() {
            const count = this.selectedTags.size;
            const countElement = document.getElementById('selectedTagsCount');
            const viewButton = document.getElementById('viewTagsBtn');

            if (count === 0) {
                countElement.textContent = 'No tags selected';
                viewButton.disabled = true;
            } else {
                countElement.textContent = `${count} tag${count === 1 ? '' : 's'} selected`;
                viewButton.disabled = false;
            }
        }

        clear() {
            this.selectedTags.clear();
            this.renderSelectedTags();
            //this.updateUI();
            document.getElementById('tagSearch').value = '';
            document.getElementById('tagDropdown').style.display = 'none';
        }

        viewSelected() {
            if (this.selectedTags.size === 0) return;

            const tagIds = Array.from(this.selectedTags.keys()).join(',');
            const url = `/Video/ByMultipleTags?tagIds=${tagIds}`;
            window.location.href = url;
        }
    }

    // Global functions
    let multiTagSelector;

    document.addEventListener('DOMContentLoaded', function() {
        multiTagSelector = new MultiTagSelector();
    });

    function addTagToSelection(tagId, tagName) {
        multiTagSelector.selectTag(tagId, tagName);
    }

    async function editTags() {
        document.getElementById('tagsView').style.display = 'none';
        document.getElementById('tagsEdit').style.display = '';

        multiTagSelector.renderSelectedTags();

        if (multiTagSelector.allTags.length === 0) {
            try {
                const response = await fetch('/Video/GetAllTags');
                if (response.ok) {
                    multiTagSelector.allTags = await response.json();
                } else {
                    console.error('Failed to load tags:', response.statusText);
                }
            } catch (error) {
                console.error('Error loading tags:', error);
            }
        }
    }

    function cancelTagsEdit() {
        document.getElementById('tagsView').style.display = '';
        document.getElementById('tagsEdit').style.display = 'none';
    }
</script>

<style>
.notes-content {
    word-wrap: break-word;
}

.card .btn-sm {
    font-size: 0.8rem;
}

#notesEdit textarea {
    resize: vertical;
    min-height: 100px;
}

.tag-badge {
    font-size: 0.9em;
    padding: 0.4em 0.8em;
    margin: 0.2em;
    text-decoration: none;
}

.tag-badge:hover {
    transform: scale(1.05);
    transition: transform 0.2s;
}

    .collapse .card-body {
        background-color: #f8f9fa;
    }

    .alert-sm {
        padding: 0.5rem;
        margin-bottom: 0.75rem;
        font-size: 0.875rem;
    }

    #clippingPanel .btn-link {
        color: inherit;
        border: none;
        background: none;
    }

        #clippingPanel .btn-link:hover {
            color: #0d6efd;
        }

    #clippingPanel .bi-chevron-down {
        transition: transform 0.2s;
    }

    #clippingPanel.show .bi-chevron-down {
        transform: rotate(180deg);
    }

    .input-group-sm .btn {
        padding: 0.25rem 0.5rem;
    }
</style>