<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Video Library</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow mb-3">
            <div class="container-fluid">
                <a class="navbar-brand" asp-area="" asp-controller="Home" asp-action="Index">Video Library</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">
                    <ul class="navbar-nav flex-grow-1">
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-area="" asp-controller="Home" asp-action="Tags">Tags</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-controller="Playlist" asp-action="Saved">
                                <i class="bi bi-collection-play"></i> Playlists
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-area="" asp-controller="Content" asp-action="Index">Content</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-area="" asp-controller="Admin" asp-action="Index">
                                <i class="bi bi-gear"></i> Admin
                            </a>
                        </li>
                    </ul>

                    <!-- Search Form -->
                    <form class="d-flex me-3" asp-controller="Home" asp-action="Search" method="get">
                        <div class="input-group">
                            <input class="form-control" type="search" name="q" placeholder="Search videos..."
                                   value="@ViewData["SearchQuery"]" aria-label="Search">
                            <button class="btn btn-outline-secondary" type="submit">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </form>

                    <ul class="navbar-nav">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="bi bi-person-circle"></i> @User.Identity?.Name
                            </a>
                            <ul class="dropdown-menu">
                                <li>
                                    <form asp-controller="Auth" asp-action="Logout" method="post" class="d-inline">
                                        <button type="submit" class="dropdown-item">
                                            <i class="bi bi-box-arrow-right"></i> Logout
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>
    <div class="container">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/toast.js" asp-append-version="true"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)

    <!-- Tag Tree Navigator Component -->
    <!-- Add this to your _Layout.cshtml or individual views -->
    <!-- Toggle Button (floating button on left side) -->
    <button id="tagTreeToggleBtn" class="tag-tree-toggle-btn" aria-label="Toggle Tag Navigator">
        <i class="bi bi-tag-fill"></i>
    </button>

    <!-- Tag Tree Sidebar -->
    <div id="tagTreeSidebar" class="tag-tree-sidebar">
        <div class="tag-tree-header">
            <h5 class="mb-0">
                <i class="bi bi-tags-fill me-2"></i>
                Tag Navigator
            </h5>
            <div class="tag-tree-controls">
                <button id="tagTreePinBtn" class="btn btn-sm btn-link" title="Pin sidebar">
                    <i class="bi bi-pin"></i>
                </button>
                <button id="tagTreeCloseBtn" class="btn btn-sm btn-link" title="Close">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>

        <div class="tag-tree-search">
            <div class="input-group input-group-sm">
                <span class="input-group-text">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" id="tagTreeSearch" class="form-control" placeholder="Search tags...">
                <button class="btn btn-outline-secondary" type="button" id="tagTreeClearSearch" style="display: none;">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="tag-tree-search-actions mt-2">
                <button id="tagTreeExpandAll" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-arrows-expand"></i> Expand All
                </button>
                <button id="tagTreeCollapseAll" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-arrows-collapse"></i> Collapse All
                </button>
            </div>
        </div>

        <div class="tag-tree-content">
            <div id="tagTreeLoading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted mt-2">Loading tags...</p>
            </div>
            <div id="tagTreeContainer" style="display: none;">
                <!-- Tree will be rendered here -->
            </div>
            <div id="tagTreeEmpty" style="display: none;" class="text-center py-5 text-muted">
                <i class="bi bi-tags" style="font-size: 3rem;"></i>
                <p class="mt-2">No tags found</p>
            </div>
        </div>

        <div class="tag-tree-footer">
            <small class="text-muted">
                <span id="tagTreeCount">0</span> tags
                <span id="tagTreeSelected" style="display: none;">
                    | <span class="text-primary"><span id="tagTreeSelectedCount">0</span> selected</span>
                </span>
            </small>
        </div>
    </div>

    <!-- Overlay (shown when sidebar is open and not pinned) -->
    <div id="tagTreeOverlay" class="tag-tree-overlay"></div>

    <link rel="stylesheet" href="~/css/tagNavigator.css" asp-append-version="true" />
    <script src="~/js/tagTreeNavigator.js"></script>
    <script>
        // Initialize the tag tree navigator when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            const tagTree = new TagTreeNavigator({
                containerId: 'tagTreeContainer',
                loadingId: 'tagTreeLoading',
                emptyId: 'tagTreeEmpty',

                // API endpoint to load tags
                loadUrl: '/Home/GetAllTagsHierarchicalWithService',

                // Callbacks
                onTagClick: function(tag) {
                    // Navigate to tag page
                    window.location.href = `/Video/ByTag/${tag.id}`;
                },

                onTagSelect: function(tag) {
                    console.log('Tag selected:', tag);
                },

                // Options
                showCounts: true,
                rememberState: true, // Remember expanded/collapsed state in localStorage
                multiSelect: false
            });

            // Make it globally accessible if needed
            window.tagTreeNavigator = tagTree;
        });
    </script>
</body>
</html>