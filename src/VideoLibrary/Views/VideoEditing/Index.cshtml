@using VideoLibrary.Models.ViewModels
@model VideoEditingViewModel

@{
    ViewData["Title"] = $"Edit Clips - {Model.Video.Title}";
}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Tags</a></li>
        <li class="breadcrumb-item"><a href="@Url.Action("Details", "Video", new { id = Model.Video.Id })">@Model.Video.Title</a></li>
        <li class="breadcrumb-item active">Edit Clips</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-scissors"></i> Edit Video Clips</h1>
    <div>
        <a href="@Url.Action("Details", "Video", new { id = Model.Video.Id })" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Video
        </a>
    </div>
</div>

<div class="row">
    <!-- Video Player Section -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">@Model.Video.Title</h5>
            </div>
            <div class="card-body p-0">
                <div class="ratio ratio-16x9">
                    <video id="editingVideo" controls class="rounded-bottom" preload="metadata"
                           poster="@(!string.IsNullOrEmpty(Model.Video.ThumbnailPath) ? Url.Action("Thumbnail", "Video", new { id = Model.Video.Id }) : "")">
                        <source src="@Url.Action("Stream", "Video", new { id = Model.Video.Id })" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>

                <div class="p-3">
                    <div class="mb-3">
                        <label class="form-label">Current Time: <span id="currentTimeDisplay">0:00</span></label>
                        <div class="d-flex gap-2 mb-2">
                            <button type="button" class="btn btn-success btn-sm" onclick="setClipStart()">
                                <i class="bi bi-play-circle"></i> Set Start
                            </button>
                            <button type="button" class="btn btn-danger btn-sm" onclick="setClipEnd()">
                                <i class="bi bi-stop-circle"></i> Set End
                            </button>
                            <button type="button" class="btn btn-primary btn-sm" onclick="addClip()" id="addClipBtn" disabled>
                                <i class="bi bi-plus-circle"></i> Add Clip
                            </button>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label for="clipStart" class="form-label">Start Time (seconds)</label>
                                <input type="number" id="clipStart" class="form-control form-control-sm"
                                       step="0.1" min="0" placeholder="0.0" onchange="validateClip()">
                            </div>
                            <div class="col-md-6">
                                <label for="clipEnd" class="form-label">End Time (seconds)</label>
                                <input type="number" id="clipEnd" class="form-control form-control-sm"
                                       step="0.1" min="0" placeholder="0.0" onchange="validateClip()">
                            </div>
                        </div>

                        <div class="mt-2">
                            <small class="text-muted">Duration: <span id="clipDuration">0.0s</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Clips List Section -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Clip List</h5>
                <span class="badge bg-secondary" id="clipCount">0 clips</span>
            </div>
            <div class="card-body">
                <div id="clipsList" class="clips-container">
                    <div class="text-muted text-center py-4" id="emptyClipsMessage">
                        <i class="bi bi-scissors" style="font-size: 2rem;"></i>
                        <p class="mb-0">No clips added yet</p>
                        <small>Use the controls above to add clips</small>
                    </div>
                </div>

                <div class="mt-3 d-grid gap-2" id="exportSection" style="display: none;">
                    <button type="button" class="btn btn-success" onclick="exportClips()">
                        <i class="bi bi-download"></i> Export Clip Data
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="clearAllClips()">
                        <i class="bi bi-trash"></i> Clear All Clips
                    </button>
                </div>
            </div>
        </div>

        <!-- Video Info -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Video Information</h6>
            </div>
            <div class="card-body">
                <p><strong>Duration:</strong> @Model.Video.DurationFormatted</p>
                <p><strong>Resolution:</strong> @Model.Video.ResolutionFormatted</p>
                <p><strong>File Size:</strong> @Model.Video.FileSizeFormatted</p>
                <p><strong>File Path:</strong><br><code class="small">@Model.Video.FilePath</code></p>
            </div>
        </div>
    </div>
</div>

<script>
    class VideoClipEditor {
        constructor() {
            this.video = document.getElementById('editingVideo');
            this.clips = [];
            this.clipIdCounter = 0;

            this.initializeEventListeners();
        }

        initializeEventListeners() {
            // Update current time display
            this.video.addEventListener('timeupdate', () => {
                document.getElementById('currentTimeDisplay').textContent = this.formatTime(this.video.currentTime);
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT') return;

                switch(e.key) {
                    case 's':
                    case 'S':
                        e.preventDefault();
                        this.setClipStart();
                        break;
                    case 'e':
                    case 'E':
                        e.preventDefault();
                        this.setClipEnd();
                        break;
                    case 'a':
                    case 'A':
                        e.preventDefault();
                        this.addClip();
                        break;
                    case ' ':
                        // Don't prevent default for spacebar (video play/pause)
                        break;
                }
            });
        }

        setClipStart() {
            const currentTime = this.video.currentTime;
            document.getElementById('clipStart').value = currentTime.toFixed(1);
            this.validateClip();
        }

        setClipEnd() {
            const currentTime = this.video.currentTime;
            document.getElementById('clipEnd').value = currentTime.toFixed(1);
            this.validateClip();
        }

        validateClip() {
            const startInput = document.getElementById('clipStart');
            const endInput = document.getElementById('clipEnd');
            const durationSpan = document.getElementById('clipDuration');
            const addBtn = document.getElementById('addClipBtn');

            const start = parseFloat(startInput.value) || 0;
            const end = parseFloat(endInput.value) || 0;
            const duration = Math.max(0, end - start);

            durationSpan.textContent = duration.toFixed(1) + 's';

            const isValid = duration > 0 && start >= 0 && end <= this.video.duration;
            addBtn.disabled = !isValid;

            if (isValid) {
                addBtn.classList.remove('btn-secondary');
                addBtn.classList.add('btn-primary');
            } else {
                addBtn.classList.remove('btn-primary');
                addBtn.classList.add('btn-secondary');
            }
        }

        addClip() {
            const start = parseFloat(document.getElementById('clipStart').value) || 0;
            const end = parseFloat(document.getElementById('clipEnd').value) || 0;
            const duration = end - start;

            if (duration <= 0) {
                alert('End time must be after start time');
                return;
            }

            const clip = {
                id: ++this.clipIdCounter,
                start: start,
                duration: duration,
                end: end
            };

            this.clips.push(clip);
            this.sortClips();
            this.renderClips();
            this.updateUI();

            // Clear inputs
            document.getElementById('clipStart').value = '';
            document.getElementById('clipEnd').value = '';
            this.validateClip();
        }

        removeClip(clipId) {
            this.clips = this.clips.filter(clip => clip.id !== clipId);
            this.renderClips();
            this.updateUI();
        }

        sortClips() {
            this.clips.sort((a, b) => a.start - b.start);
        }

        renderClips() {
            const container = document.getElementById('clipsList');
            const emptyMessage = document.getElementById('emptyClipsMessage');

            if (this.clips.length === 0) {
                container.innerHTML = '';
                container.appendChild(emptyMessage);
                return;
            }

            const html = this.clips.map(clip => `
                <div class="clip-item mb-2" data-clip-id="${clip.id}">
                    <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                        <div class="flex-grow-1">
                            <div class="fw-bold">Clip ${clip.id}</div>
                            <div class="small text-muted">
                                ${this.formatTime(clip.start)} - ${this.formatTime(clip.end)}
                                (${this.formatTime(clip.duration)})
                            </div>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-primary" onclick="clipEditor.jumpToClip(${clip.id})" title="Jump to start">
                                <i class="bi bi-skip-start"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="clipEditor.removeClip(${clip.id})" title="Remove clip">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        jumpToClip(clipId) {
            const clip = this.clips.find(c => c.id === clipId);
            if (clip) {
                this.video.currentTime = clip.start;
            }
        }

        updateUI() {
            const count = this.clips.length;
            document.getElementById('clipCount').textContent = `${count} clip${count === 1 ? '' : 's'}`;

            const exportSection = document.getElementById('exportSection');
            exportSection.style.display = count > 0 ? 'block' : 'none';
        }

        clearAllClips() {
            if (this.clips.length === 0) return;

            if (confirm('Are you sure you want to clear all clips? This action cannot be undone.')) {
                this.clips = [];
                this.renderClips();
                this.updateUI();
            }
        }

        exportClips() {
            if (this.clips.length === 0) {
                alert('No clips to export');
                return;
            }

            const exportData = {
                VideoName: '@Model.Video.Title',
                VideoPath: '@Model.Video.FilePath',
                Clips: this.clips.map(clip => ({
                    Start: clip.start,
                    Duration: clip.duration
                }))
            };

            // Send to server for download
            fetch('@Url.Action("ExportClips")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(exportData)
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `@(System.IO.Path.GetFileNameWithoutExtension(Model.Video.Title))_clips.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Export failed:', error);
                alert('Failed to export clips');
            });
        }

        formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);

            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }
    }

    // Global functions for onclick handlers
    let clipEditor;

    function setClipStart() {
        clipEditor.setClipStart();
    }

    function setClipEnd() {
        clipEditor.setClipEnd();
    }

    function addClip() {
        clipEditor.addClip();
    }

    function validateClip() {
        clipEditor.validateClip();
    }

    function clearAllClips() {
        clipEditor.clearAllClips();
    }

    function exportClips() {
        clipEditor.exportClips();
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        clipEditor = new VideoClipEditor();
    });
</script>

<style>
    .clips-container {
        max-height: 400px;
        overflow-y: auto;
    }

    .clip-item {
        transition: background-color 0.2s;
    }

        .clip-item:hover {
            background-color: #f8f9fa;
        }

        .clip-item .border {
            border-color: #dee2e6 !important;
        }

        .clip-item:hover .border {
            border-color: #adb5bd !important;
        }

    #editingVideo {
        width: 100%;
        max-height: 70vh;
    }

    .btn-group-sm .btn {
        padding: 0.25rem 0.4rem;
        font-size: 0.875rem;
    }

    

    .form-control-sm {
        font-size: 0.875rem;
    }

    code.small {
        font-size: 0.75rem;
        word-break: break-all;
    }
</style>